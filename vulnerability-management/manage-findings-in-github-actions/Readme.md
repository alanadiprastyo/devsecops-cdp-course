Automated Results Upload in GitHub Actions
----------------------------------------------------------------

Use script(s) to automatically push security findings to Vulnerability Management system from CI/CD
----

In this scenario, you will learn how to automatically manage security issues using vulnerability management systems like Defect Dojo.

A simple CI/CD pipeline
--------------------------------

1. Create a new repository
2. Create a Personal Access Token (PAT)
3. Initial git setup
4. Download the repository (django.nv)
5. Add a workflow file to the repository
6. Push the changes to the repository
7. Verify the pipeline runs

Machine(s) access
----

- Key: DOJO_HOST
- Value: dojo-XqiHnDZ0.lab.practical-devsecops.training
>
- Key: DOJO_API_TOKEN
- Value: Find it at https://dojo-XqiHnDZ0.lab.practical-devsecops.training/api/key-v2


Upload script
----------
You can use the upload-results.py script from https://gitlab.practical-devsecops.training/-/snippets/3/raw

Exercise
---------

We will use the bandit tool to scan a repository for security issues and upload the tool’s output to DefectDojo in CI/CD pipeline.

1. Read the bandit documentation
2. Embed bandit as build job and save the output as JSON file
3. Where should you upload the upload-results.py file for the fully automated pipeline to work?
4. Remember to follow all best practices while adding the baseline scan to CI/CD pipeline

> Once you are done, please do not forget to share the pipeline script with our staff.

Embed Bandit and upload script in GitHub Actions
--------------

As discussed in the Static Analysis using Bandit exercise, we can embed Bandit in our CI/CD pipeline. However, do remember you need to run the command manually before you embed this SAST tool in the pipeline.

Go back to the DevSecOps Box machine, and copy the below content to the .github/workflows/main.yaml file under test job.

```
  sast:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2

      - run: docker run --rm -v $(pwd):/src hysnsec/bandit -r /src -f json -o /src/bandit-output.json

      - uses: actions/upload-artifact@v2
        with:
          name: Bandit
          path: bandit-output.json
        if: always()                        # what is this for?

      - uses: actions/setup-python@v2
        with:
          python-version: '3.6'

      - run: python3 upload-results.py --host $DOJO_HOST --api_key $DOJO_API_TOKEN --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file bandit-output.json --scanner "Bandit Scan"
```

Before we commit this file to the repository, We need to set DOJO_HOST and DOJO_API_TOKEN using secrets in our repository. To set up a secret, go back to django.nv repository and click the Settings tab.

Click the Secrets option, then select New repository secret and add the following credentials into it.

- Key: DOJO_HOST
- Value: dojo-XqiHnDZ0.lab.practical-devsecops.training
>
- Key: DOJO_API_TOKEN
- Value: Find it at https://dojo-XqiHnDZ0.lab.practical-devsecops.training/api/key-v2

Once done, click the Add secret button.

You also need to log into the dojo website using the following credentials to fetch the API Key.

- Dojo URL: dojo-XqiHnDZ0.lab.practical-devsecops.training/api/key-v2
- Username: root
- Password: pdso-training

Once you’re done with the variables, you can commit the .github/workflows/main.yaml file, and push the changes to GitHub.

Any change to the repo will kick start the pipeline.

We can see the result of the pipeline by visiting our django.nv repository, clicking the Actions tab, and selecting the appropriate workflow name to see the output.

The pipeline will fail because the job sast didn’t succeed. If you see the job’s output, you will realize that we didn’t upload the upload-results.py file into the repo and the CI system failed the build as it couldn’t find it in the repository.

Let’s move to the next page to add this script to the repository via the Git command line. Of course, we will perform these steps from DevSecOps Box.

Upload python script in CI/CD pipeline
----------

Lets download the upload-results.py script using the following curl command.

```
curl https://gitlab.practical-devsecops.training/-/snippets/3/raw -o upload-results.py
git add upload-results.py
git commit -m "Add upload-results.py file"
git push origin main
```

As discussed earlier, any change to the repo kick starts the pipeline. We can see the result of the pipeline by visiting our django.nv repository, clicking the Actions tab, and selecting the appropriate workflow name to see the output.

There you have it. Every time a developer makes a change, our SAST scanner will run and will automatically upload the results to the vulnerability management system.

You can verify the issues were uploaded successfully by visiting the dojo website.