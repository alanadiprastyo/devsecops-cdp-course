Vulnerability Management with DefectDojo
================================

Learn how to use Defect Dojo to manage vulnerabilities
----------------------------------------------------------------

In this scenario, you will learn how to use Defect Dojo to manage vulnerabilities in a DevSecOps environment.

You will run bandit scan on a repository and then upload the results to Defect Dojo.

To achieve the above objectives, you will need to do the following.
1. Clone/download the source code
2. Install bandit tool
3. Run the SAST scan on the source code
4. Upload the result to DefectDojo with custom script

Download the source code
----------

We will do all the exercises locally first in DevSecOps-Box, so let’s start the exercise.

First, we need to download the source code of the project from our git repository.

```
git clone https://gitlab.practical-devsecops.training/pdso/django.nv webapp
cd webapp
```

Install SAST Tool
----------

Let’s install the bandit scanner on the system to perform static analysis.

```
pip3 install bandit
```
We have successfully installed the bandit scanner.

Run the scanner
----------

As we have learned in the DevSecOps Gospel, we would like to store the tool results in a JSON file. We are using the tee command here to show the output and store it in a file simultaneously.

```
bandit -r . -f json | tee bandit-output.json
```

Bandit ran successfully, and it found three security issues.
1. Two medium severity issues
2. One high severity issue

Let’s upload this file to Defect Dojo in the next step.

Upload the results to Defect Dojo
-----------

Let’s explore the Defect Dojo application now.

Defect Dojo provides an API to upload the scan results, and this is an excellent feature for uploading scan results during CI/CD process. We have created a simple upload script for you, and you can download this script using the following command.

```
curl https://gitlab.practical-devsecops.training/-/snippets/3/raw -o upload-results.py
python3 upload-results.py --help
```
output

```
Traceback (most recent call last):
  File "upload-results.py", line 7, in <module>
    import requests
ModuleNotFoundError: No module named 'requests'
```
It looks like the module requests is not available. Lets install it and upload the results.

```
pip3 install requests
```
Now, we can try re-running the command and see if it works.
```
python3 upload-results.py --help
```
output
```
usage: upload-results.py [-h] --host HOST --api_key API_KEY --engagement_id
                         ENGAGEMENT_ID --result_file RESULT_FILE --scanner
                         SCANNER --product_id PRODUCT_ID --lead_id LEAD_ID
                         [--build_id BUILD_ID]

CI/CD integration for DefectDojo

optional arguments:
  -h, --help            show this help message and exit
  --host HOST           DefectDojo Hostname
  --api_key API_KEY     API v2 Key
  --engagement_id ENGAGEMENT_ID
                        Engagement ID
  --result_file RESULT_FILE
                        Scanner file
  --scanner SCANNER     Type of scanner
  --product_id PRODUCT_ID
                        DefectDojo Product ID
  --lead_id LEAD_ID     ID of the user conducting the testing
  --environment ENVIRONMENT
                        Environment name
  --build_id BUILD_ID   Reference to external build id
```
We need to provide the following inputs for this script to work.

- Host : https://dojo-XqiHnDZ0.lab.practical-devsecops.training
- Username : root
- API_KEY : Find it at https://dojo-XqiHnDZ0.lab.practical-devsecops.training/api/key-v2
- ENGAGEMENT_ID: ID of the engagement, here its 1
- PRODUCT_ID: ID of product, here its 1
- LEAD_ID: ID of the user conducting the testing
- ENVIRONMENT: Environment name
- SCANNER: Name of the scanner, this is case sensitive e.g., ZAP Scan, Bandit Scan, etc
- RESULT_FILE: The path to the tool’s output

You need to first log into the dojo website using the following credentials to fetch the API Key.

- Dojo URL: https://dojo-xqihndz0.lab.practical-devsecops.training/api/key-v2
- Username: root
- Password: pdso-training

You can copy the API_KEY from the DefectDojo app and replace INSERT_API_KEY_HERE with the API_KEY in the below command.

```
export API_KEY=INSERT_API_KEY_HERE
```
You can also use the following command to get a token programmatically.

```
export API_KEY=$(curl -s -XPOST -H 'content-type: application/json' https://dojo-XqiHnDZ0.lab.practical-devsecops.training/api/v2/api-token-auth/ -d '{"username": "root", "password": "pdso-training"}' | jq -r '.token' )
```

> Make sure the API_KEY shows an output when executing echo $API_KEY command. If not, you need to wait until the DefectDojo is ready.

We can now upload the bandit’s scan output (bandit-output.json) to Defect Dojo.

```
python3 upload-results.py --host dojo-XqiHnDZ0.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file bandit-output.json --scanner "Bandit Scan"
```
output
```
{'Authorization': 'Token 6af287e26400d905720156c5e0965ea236dabe35'}
{'minimum_severity': 'Low', 'scan_date': '2021-02-16', 'verified': False, 'active': False, 'engagement': '1', 'lead': '1', 'scan_type': 'Bandit Scan', 'environment': 'Production'}
Successfully uploaded the results to Defect Dojo
```

Visit the https://dojo-XqiHnDZ0.lab.practical-devsecops.training/engagement/1 to see the uploaded issues.


Exercise: Upload ZAP results to Defect Dojo manually
----
In this exercise, you will use the upload-results.py script to upload the ZAP Scan results to the Defect Dojo.

1. Scan the production machine https://prod-XqiHnDZ0.lab.practical-devsecops.training with the help of the ZAP docker image
2. Store the ZAP scan results in a file and upload the results to Defect Dojo

> Please do not forget to share the answer (a screenshot and commands) with our staff via Slack Direct Message (DM).

Hint
---------

Explore the different features Dojo provides while keeping a note of URL changes in the address bar of your browser
Atleast visit, product page, engagement page and tests options in the Dojo portal
The 500 error while uploading ZAP’s output is because of the wrong arguments used. Please read the documentation of Dojo to resolve the error

Answer
---------
1. Scan the production machine https://prod-XqiHnDZ0.lab.practical-devsecops.training with the help of the ZAP docker image
```
docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw --rm owasp/zap2docker-stable zap-baseline.py -t https://prod-XqiHnDZ0.lab.practical-devsecops.training -x zap-output.xml
```

2. Store the ZAP scan results in a file and upload the results to Defect Dojo

```
python3 upload-results.py --host dojo-XqiHnDZ0.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file zap-output.xml --scanner "ZAP Scan"
```